# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Path to your Oh My Zsh installation.
export ZSH="$HOME/.oh-my-zsh"

# Theme
ZSH_THEME="powerlevel10k/powerlevel10k"

# Plugins
plugins=(
  git
  sudo
  extract
  kubectl
  gcloud
  poetry
  zsh-autosuggestions
  zsh-syntax-highlighting
  zsh-history-substring-search
  zsh-kubectl-prompt
)

# Load Oh My Zsh
source $ZSH/oh-my-zsh.sh

# Powerlevel10k (homebrew)
source /opt/homebrew/share/powerlevel10k/powerlevel10k.zsh-theme

# Autosuggestions style
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=23'

# Source additional plugins from homebrew
source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
source /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

# Initialize go-prj-root
source /Users/nemanjamudrinic/.local/bin/go-prj-root

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh


#### PATH Exports ####
export PATH="$HOME/.local/bin:$PATH"
export PATH="/opt/homebrew/opt/mysql-client/bin:$PATH"
export PATH="/opt/homebrew/opt/postgresql@16/bin:$PATH"
export PATH="$HOME/development/flutter/bin:$PATH"
export PATH="$PATH:/Users/nemanjamudrinic/Library/Python/3.14/bin"

#### NVM ####
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"


#### pyenv ####
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
if command -v pyenv &> /dev/null; then
  eval "$(pyenv init --path)"
  eval "$(pyenv init -)"
fi


#### API Keys ####
export GEMINI_API_KEY=AIzaSyCYSGkJ8wr8VV4HJz0KnwqWuVrvTJFvbww


#### CLI Tools ####
# direnv
eval "$(direnv hook zsh)"

# thefuck (if installed)
if command -v thefuck &> /dev/null; then
  eval $(thefuck --alias)
fi

# fzf key bindings and fuzzy completion
if command -v fzf &> /dev/null; then
  source <(fzf --zsh)
fi

# zoxide for better cd
if command -v zoxide &> /dev/null; then
  eval "$(zoxide init zsh)"
fi


#### Keybindings ####
bindkey "$terminfo[kcuu1]" history-substring-search-up
bindkey "$terminfo[kcud1]" history-substring-search-down


#### FZF Configuration ####
if command -v fd &> /dev/null; then
  export FZF_DEFAULT_COMMAND="fd --hidden --strip-cwd-prefix --exclude .git"
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
  export FZF_ALT_C_COMMAND="fd --type=d --hidden --strip-cwd-prefix --exclude .git"
fi

# FZF preview (requires eza and bat)
show_file_or_dir_preview="if [ -d {} ]; then eza --tree --color=always {} | head -200; else bat -n --color=always --line-range :500 {}; fi"
export FZF_CTRL_T_OPTS="--preview '$show_file_or_dir_preview'"
export FZF_ALT_C_OPTS="--preview 'eza --tree --color=always {} | head -200'"

# bat theme
export BAT_THEME="Catppuccin Macchiato"


#### Kubectl Prompt ####
function kubectl_prompt() {
  context=$(echo "$ZSH_KUBECTL_CONTEXT" | cut -d'_' -f2)
  if [ -n "$context" ]; then
    echo "$context"
  fi
}
RPROMPT='%{$fg[blue]%}($(kubectl_prompt))%{$reset_color%}'


#### Aliases ####
alias refresh='source ~/.zshrc'

# Modern replacements (if installed)
if command -v eza &> /dev/null; then
  alias ls='eza -lh --group-directories-first --icons=auto --sort=extension'
  alias la='ls -a'
  alias lt='eza --tree --level=3 --git --group-directories-first --sort=extension'
  alias lta='lt -a'
fi

if command -v bat &> /dev/null; then
  alias cat='bat'
fi

if command -v zoxide &> /dev/null; then
  alias cd='z'
fi

if command -v nvim &> /dev/null; then
  alias vim='nvim'
fi

if command -v rg &> /dev/null; then
  alias grep='rg'
fi

# Kubernetes
alias k="kubectl"
alias kswitchcontext='kubectl config use-context $(kubectl config get-contexts -o name | fzf)'

# Git
alias diff='git diff --no-index'

# fzf helpers
alias ff="fzf --preview '$show_file_or_dir_preview'"
alias fman='compgen -c | fzf | xargs man'
alias ftldr='compgen -c | fzf | xargs tldr'
alias tmux-keys='tmux list-keys | fzf'
alias tmux-kill='tmux ls | fzf -m | cut -d: -f1 | xargs -I {} tmux kill-session -t {}'
alias tmux-switch='tmux switch-client -t $(tmux ls | fzf | cut -d: -f1)'
alias tmux-refresh='tmux source-file ~/.tmux.conf && echo "tmux config reloaded"'

# thefuck shortcut
alias f='fuck'

# fd with hidden files
alias fd='fd -H --exclude .git'

# Safe delete
alias del="trash"


#### Functions ####
function trash() {
  mv -f "$1" ~/.Trash 2>/dev/null && echo "Moved to Trash: '$1'" || {
    rm -rf "$1" && echo "Deleted: '$1'" || echo "Failed to delete: '$1'"
  }
}

function history-fzf() {
  local selected
  selected=$(history | awk '{ $1=""; print substr($0,2) }' | fzf --height 40% --reverse --border --ansi) || return
  if [[ -n $selected ]]; then
    printf '%s' "$selected" | pbcopy
    echo "Copied to clipboard: $selected"
  fi
}

function git-keys() {
  git_plugin_file="$HOME/.oh-my-zsh/plugins/git/git.plugin.zsh"
  if [[ -f "$git_plugin_file" ]]; then
    grep "^alias" "$git_plugin_file" | fzf
  else
    echo "Git plugin file not found."
  fi
}

function work-screen() {
  local dir="${1:-$(pwd)}"

  # Ask for session name
  echo -n "Session name: "
  read session_name
  session_name="${session_name:-work}"

  cd "$dir"

  # Create Ghostty splits layout with tmux sessions:
  # Left: claude | Right top: nvim
  #              | Right bottom: terminal

  osascript <<EOF
    tell application "Ghostty"
      activate
      delay 0.2

      -- Split right (Cmd+D)
      tell application "System Events"
        keystroke "d" using command down
      end tell
      delay 0.3

      -- Create tmux session for nvim in right pane
      tell application "System Events"
        keystroke "tmux new-session -s ${session_name}-nvim -c ${dir} \\\\; send-keys 'nvim' Enter"
        key code 36  -- Enter
      end tell
      delay 0.2

      -- Split down (Cmd+Shift+D)
      tell application "System Events"
        keystroke "d" using {command down, shift down}
      end tell
      delay 0.2

      -- Create tmux session for terminal in bottom right pane
      tell application "System Events"
        keystroke "tmux new-session -s ${session_name}-terminal -c ${dir}"
        key code 36  -- Enter
      end tell
      delay 0.2

      -- Resize terminal pane smaller (Cmd+Shift+Down 3 times)
      tell application "System Events"
        repeat 3 times
          key code 125 using {command down, shift down}  -- Down arrow
          delay 0.05
        end repeat
      end tell
      delay 0.1

      -- Go to left pane (Alt+H)
      tell application "System Events"
        key code 4 using option down  -- h key
      end tell
      delay 0.1

      -- Create tmux session for claude in left pane
      tell application "System Events"
        keystroke "tmux new-session -s ${session_name}-claude -c ${dir} \\\\; send-keys 'claude' Enter"
        key code 36  -- Enter
      end tell
      delay 0.2

      -- Resize left pane to ~20-25% (Cmd+Shift+Left 5 times)
      tell application "System Events"
        repeat 5 times
          key code 123 using {command down, shift down}  -- Left arrow
          delay 0.05
        end repeat
      end tell
    end tell
EOF
}

# Keep tmux version as backup
function work-screen-tmux() {
  local dir="${1:-$(pwd)}"
  echo -n "Session name: "
  read name
  local session_name="${name:-work}-$(date +%s)"

  # Create tmux session with 3 panes
  tmux new-session -d -s "$session_name" -c "$dir"
  tmux split-window -h -t "$session_name" -c "$dir" -l 75%
  tmux split-window -v -t "$session_name" -c "$dir" -l 15%

  tmux send-keys -t "$session_name:0.0" "claude" Enter
  tmux send-keys -t "$session_name:0.1" "nvim" Enter

  tmux attach -t "$session_name"
}


#### FZF Completion Customizations ####
_fzf_compgen_path() {
  fd --hidden --exclude .git . "$1"
}

_fzf_compgen_dir() {
  fd --type=d --hidden --exclude .git . "$1"
}

_fzf_comprun() {
  local command=$1
  shift
  case "$command" in
    cd)           fzf --preview 'eza --tree --color=always {} | head -200' "$@" ;;
    export|unset) fzf --preview "eval 'echo \${}'"         "$@" ;;
    ssh)          fzf --preview 'dig {}'                   "$@" ;;
    *)            fzf --preview "$show_file_or_dir_preview" "$@" ;;
  esac
}


#### Load custom configs if they exist ####
[ -f $HOME/.config/zsh/zsh_aliases ] && source $HOME/.config/zsh/zsh_aliases
[ -f $HOME/.config/zsh/zsh_functions ] && source $HOME/.config/zsh/zsh_functions
[ -f $HOME/.config/zsh/fzf-git.sh ] && source $HOME/.config/zsh/fzf-git.sh
[ -f $HOME/.config/zsh/fzf_tokyonight_storm ] && source $HOME/.config/zsh/fzf_tokyonight_storm

